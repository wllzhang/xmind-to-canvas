!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jszip"),require("elkjs/lib/elk.bundled")):"function"==typeof define&&define.amd?define(["exports","jszip","elkjs/lib/elk.bundled"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).XMindToCanvas={},e.JSZip,e.ELK)}(this,function(e,t,r){"use strict";function i(e,t,r,i){return new(r||(r=Promise))(function(n,o){function a(e){try{d(i.next(e))}catch(e){o(e)}}function s(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,s)}d((i=i.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;const n={layoutAlgorithm:"mrtree",direction:"RIGHT",nodeSpacing:80,layerSpacing:150,defaultNodeWidth:200,defaultNodeHeight:80};class o{parse(e){return i(this,void 0,void 0,function*(){try{const r=yield t.loadAsync(e);let i=r.file("content.json"),n=!0;if(i||(i=r.file("content.xml"),n=!1),!i)throw new Error("No content.json or content.xml found in XMind file");const o=yield i.async("text");let a;if(!n)throw new Error("XML format (.xmind) is not yet supported. Please use XMind Zen format.");a=JSON.parse(o);const s=yield this.extractImages(r),d=[];if(a&&Array.isArray(a))for(const e of a){const t=e.rootTopic;t&&d.push({id:e.id||this.generateId(),title:e.title||"Untitled Sheet",rootTopic:this.extractNodes(t)})}if(0===d.length)throw new Error("No valid sheets found in XMind file");return{sheets:d,images:s}}catch(e){throw console.error("Error parsing XMind file:",e),new Error(`Failed to parse XMind file: ${(null==e?void 0:e.message)||"Unknown error"}`)}})}extractImages(e){return i(this,void 0,void 0,function*(){const t=new Map,r=Object.keys(e.files).filter(e=>e.startsWith("resources/")&&!e.endsWith("/"));for(const i of r){const r=e.file(i);if(r)try{const e=yield r.async("arraybuffer"),n=i.replace("resources/",""),o=this.getMimeType(n);o&&t.set(n,{name:n,data:e,mimeType:o})}catch(e){console.warn(`Failed to extract image: ${i}`,e)}}return t})}getMimeType(e){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",bmp:"image/bmp"}[e.toLowerCase().split(".").pop()||""]||null}extractNodes(e,t){const r=e.title||e.label||e.name||"Untitled",i={id:e.id||this.generateId(),title:String(r),children:[]};if(e.notes&&(i.notes=e.notes.plain||e.notes),e.labels&&Array.isArray(e.labels)?i.labels=e.labels:e.labels&&"string"==typeof e.labels&&(i.labels=[e.labels]),e.markers&&Array.isArray(e.markers)&&(i.markers=e.markers),e.image&&e.image.src){const t=e.image.src.match(/(?:xap:)?resources\/(.+)$/);t&&(i.image={src:t[1],width:e.image.width,height:e.image.height})}let n=[];return e.children?e.children.attached&&Array.isArray(e.children.attached)?n=e.children.attached:Array.isArray(e.children)&&(n=e.children):e.attached&&Array.isArray(e.attached)?n=e.attached:e.topics&&Array.isArray(e.topics)&&(n=e.topics),n.length>0?i.children=n.map(e=>this.extractNodes(e,i.id)):i.children=[],i}generateId(){return`node-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}class a{constructor(){this.elk=new r}calculate(e,t){return i(this,void 0,void 0,function*(){try{if(!e.sheets||0===e.sheets.length)throw new Error("No sheets found in XMind file");const r=e.sheets[0].rootTopic,i=this.convertToELKGraph(r,t);return yield this.elk.layout(i)}catch(e){throw console.error("Error calculating layout:",e),new Error(`Failed to calculate layout: ${e.message}`)}})}convertToELKGraph(e,t){const r={id:"root",layoutOptions:{"elk.algorithm":t.layoutAlgorithm||"mrtree","elk.direction":t.direction||"RIGHT","elk.spacing.nodeNode":String(t.nodeSpacing||80),"elk.layered.spacing.nodeNodeBetweenLayers":String(t.layerSpacing||150)},children:[],edges:[]},{nodes:i,edges:n}=this.flattenNodeTree(e,t);return r.children=i,r.edges=n,r}flattenNodeTree(e,t,r){const i=[],n=[],o=e.title.length;let a=Math.max(t.defaultNodeWidth||200,Math.min(8*o,400)),s=t.defaultNodeHeight||80;if(e.image){const t=e.image.width||200,r=e.image.height||150;a=Math.min(Math.max(a,t),500),s=Math.max(s,r+40)}const d={id:e.id,width:a,height:s,labels:[{text:e.title}]};if(e.image&&(d.hasImage=!0,d.imageSrc=e.image.src,d.imageWidth=e.image.width,d.imageHeight=e.image.height),i.push(d),r&&n.push({id:`edge-${r}-${e.id}`,sources:[r],targets:[e.id]}),e.children&&e.children.length>0)for(const r of e.children){const o=this.flattenNodeTree(r,t,e.id);i.push(...o.nodes),n.push(...o.edges)}return{nodes:i,edges:n}}}class s{constructor(){this.imagePathGenerator=null}setImagePathGenerator(e){this.imagePathGenerator=e}generate(e){const t=[],r=[];if(e.children)for(const r of e.children){const e=this.convertNode(r);t.push(...e)}if(e.edges)for(const t of e.edges){const e=this.convertEdge(t);r.push(e)}return{nodes:t,edges:r}}convertNode(e){const t=[],r=e.labels&&e.labels.length>0?e.labels[0].text:"Untitled",i=Math.round(e.x||0),n=Math.round(e.y||0),o=Math.round(e.width||200),a=Math.round(e.height||80);if(e.hasImage&&e.imageSrc){const s=this.imagePathGenerator?this.imagePathGenerator(e.imageSrc):e.imageSrc,d={id:e.id,type:"file",x:i,y:n,width:o,height:a,file:s};if(t.push(d),r&&"Untitled"!==r){const s={id:`${e.id}-title`,type:"text",x:i,y:n+a+10,width:o,height:40,text:`### ${r}`};t.push(s)}}else{const s={id:e.id,type:"text",x:i,y:n,width:o,height:a,text:`### ${r}`};t.push(s)}return t}convertEdge(e){const t=Array.isArray(e.sources)?e.sources[0]:e.sources,r=Array.isArray(e.targets)?e.targets[0]:e.targets;return{id:e.id,fromNode:t,toNode:r,fromSide:"right",toSide:"left"}}}e.CanvasGenerator=s,e.DEFAULT_OPTIONS=n,e.LayoutCalculator=a,e.XMindParser=o,e.convertXMindToCanvas=function(e,t){return i(this,void 0,void 0,function*(){const r=new o,i=new a,d=new s,l=Object.assign(Object.assign({},n),t),c=yield r.parse(e),h=yield i.calculate(c,l);return{canvasData:d.generate(h),xmindData:c}})}});
