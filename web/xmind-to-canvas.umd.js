!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jszip"),require("elkjs/lib/elk.bundled")):"function"==typeof define&&define.amd?define(["exports","jszip","elkjs/lib/elk.bundled"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).XMindToCanvas={},e.JSZip,e.ELK)}(this,function(e,t,r){"use strict";function i(e,t,r,i){return new(r||(r=Promise))(function(n,o){function s(e){try{l(i.next(e))}catch(e){o(e)}}function a(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}l((i=i.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;const n={layoutAlgorithm:"mrtree",direction:"RIGHT",nodeSpacing:80,layerSpacing:150,defaultNodeWidth:200,defaultNodeHeight:80};class o{parse(e){return i(this,void 0,void 0,function*(){try{const r=yield t.loadAsync(e);let i=r.file("content.json"),n=!0;if(i||(i=r.file("content.xml"),n=!1),!i)throw new Error("No content.json or content.xml found in XMind file");const o=yield i.async("text");let s;if(!n)throw new Error("XML format (.xmind) is not yet supported. Please use XMind Zen format.");s=JSON.parse(o);const a=yield this.extractImages(r),l=[];if(s&&Array.isArray(s))for(const e of s){const t=e.rootTopic;t&&l.push({id:e.id||this.generateId(),title:e.title||"Untitled Sheet",rootTopic:this.extractNodes(t)})}if(0===l.length)throw new Error("No valid sheets found in XMind file");return{sheets:l,images:a}}catch(e){console.error("Error parsing XMind file:",e);const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to parse XMind file: ${t}`)}})}extractImages(e){return i(this,void 0,void 0,function*(){const t=new Map,r=Object.keys(e.files).filter(e=>e.startsWith("resources/")&&!e.endsWith("/"));for(const i of r){const r=e.file(i);if(r)try{const e=yield r.async("arraybuffer"),n=i.replace("resources/",""),o=this.getMimeType(n);o&&t.set(n,{name:n,data:e,mimeType:o})}catch(e){console.warn(`Failed to extract image: ${i}`,e)}}return t})}getMimeType(e){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",bmp:"image/bmp"}[e.toLowerCase().split(".").pop()||""]||null}extractNodes(e,t){const r=e.title||e.label||e.name||"Untitled",i=e.id,n={id:("string"==typeof i?i:null)||this.generateId(),title:String(r),children:[]};if(e.notes){const t=e.notes;n.notes=String("object"==typeof t&&null!==t&&"plain"in t?t.plain:t)}if(e.labels&&Array.isArray(e.labels)?n.labels=e.labels:e.labels&&"string"==typeof e.labels&&(n.labels=[e.labels]),e.markers&&Array.isArray(e.markers)&&(n.markers=e.markers),e.image&&"object"==typeof e.image&&null!==e.image){const t=e.image;if(t.src&&"string"==typeof t.src){const e=t.src.match(/(?:xap:)?resources\/(.+)$/);e&&(n.image={src:e[1],width:"number"==typeof t.width?t.width:void 0,height:"number"==typeof t.height?t.height:void 0})}}let o=[];if(e.children)if("object"!=typeof e.children||null===e.children||Array.isArray(e.children))Array.isArray(e.children)&&(o=e.children);else{const t=e.children;t.attached&&Array.isArray(t.attached)&&(o=t.attached)}else e.attached&&Array.isArray(e.attached)?o=e.attached:e.topics&&Array.isArray(e.topics)&&(o=e.topics);return o.length>0?n.children=o.map(e=>this.extractNodes(e,n.id)):n.children=[],n}generateId(){return`node-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}class s{constructor(){this.elk=new r}calculate(e,t){return i(this,void 0,void 0,function*(){try{if(!e.sheets||0===e.sheets.length)throw new Error("No sheets found in XMind file");const r=e.sheets[0].rootTopic,i=this.convertToELKGraph(r,t);return yield this.elk.layout(i)}catch(e){console.error("Error calculating layout:",e);const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to calculate layout: ${t}`)}})}convertToELKGraph(e,t){const r={id:"root",layoutOptions:{"elk.algorithm":t.layoutAlgorithm||"mrtree","elk.direction":t.direction||"RIGHT","elk.spacing.nodeNode":String(t.nodeSpacing||80),"elk.layered.spacing.nodeNodeBetweenLayers":String(t.layerSpacing||150)},children:[],edges:[]},{nodes:i,edges:n}=this.flattenNodeTree(e,t);return r.children=i,r.edges=n,r}flattenNodeTree(e,t,r){const i=[],n=[],o=e.title.length;let s=Math.max(t.defaultNodeWidth||200,Math.min(8*o,400)),a=t.defaultNodeHeight||80;if(e.image){const t=e.image.width||200,r=e.image.height||150;s=Math.min(Math.max(s,t),500),a=Math.max(a,r+40)}const l={id:e.id,width:s,height:a,labels:[{text:e.title}]};if(e.image&&(l.hasImage=!0,l.imageSrc=e.image.src,l.imageWidth=e.image.width,l.imageHeight=e.image.height),i.push(l),r&&n.push({id:`edge-${r}-${e.id}`,sources:[r],targets:[e.id]}),e.children&&e.children.length>0)for(const r of e.children){const o=this.flattenNodeTree(r,t,e.id);i.push(...o.nodes),n.push(...o.edges)}return{nodes:i,edges:n}}}class a{constructor(){this.imagePathGenerator=null}setImagePathGenerator(e){this.imagePathGenerator=e}generate(e){const t=[],r=[];if(e.children)for(const r of e.children){const e=this.convertNode(r);t.push(...e)}if(e.edges)for(const t of e.edges){const e=this.convertEdge(t);r.push(e)}return{nodes:t,edges:r}}convertNode(e){const t=[],r=e.labels&&e.labels.length>0?e.labels[0].text:"Untitled",i=Math.round(e.x||0),n=Math.round(e.y||0),o=Math.round(e.width||200),s=Math.round(e.height||80);if(e.hasImage&&e.imageSrc){let a=this.imagePathGenerator?this.imagePathGenerator(e.imageSrc):e.imageSrc;a.startsWith("//")&&(a=a.substring(2));const l={id:e.id,type:"file",x:i,y:n,width:o,height:s,file:a};if(t.push(l),r&&"Untitled"!==r){const a={id:`${e.id}-title`,type:"text",x:i,y:n+s+10,width:o,height:40,text:`### ${r}`};t.push(a)}}else{const a={id:e.id,type:"text",x:i,y:n,width:o,height:s,text:`### ${r}`};t.push(a)}return t}convertEdge(e){const t=Array.isArray(e.sources)?e.sources[0]:e.sources,r=Array.isArray(e.targets)?e.targets[0]:e.targets;return{id:e.id,fromNode:t,toNode:r,fromSide:"right",toSide:"left"}}}e.CanvasGenerator=a,e.DEFAULT_OPTIONS=n,e.LayoutCalculator=s,e.XMindParser=o,e.convertXMindToCanvas=function(e,t){return i(this,void 0,void 0,function*(){const r=new o,i=new s,l=new a,d=Object.assign(Object.assign({},n),t),c=yield r.parse(e),h=yield i.calculate(c,d);return{canvasData:l.generate(h),xmindData:c}})}});
